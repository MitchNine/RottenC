##########################################
## GLOBAL

MAKEFLAGS += --silent
TARGET 	:= crot
CC		:= /usr/bin/gcc

# Flags
INCS	:= -I./src/ -I ~/Documents/Dependencies/clay/
INCS	+= -L/usr/lib/
LIBS	:= -lpthread -lm -ldl -lraylib
MKF_DIR	:= $(abspath $(lastword $(MAKEFILE_LIST)))
CUR_DIR	:= $(MKF_DIR:makefile=)

# Build
BUILD := build
OBJS  :=
OBJS  += $(patsubst %.c,$(BUILD)/%.c.o, $(shell find ./src -name "*.c"))
OBJS  += $(patsubst %.cpp,$(BUILD)/%.cpp.o, $(shell find ./src -name "*.cpp"))
HEAD  := $(patsubst %.h,$(BUILD)/inc/%.h, $(shell find ./src -name "*.h" ! -name "*.internal.h"))

##########################################
## Colors
COLOR_R := \033[31m
COLOR_G := \033[32m
COLOR_B := \033[34m
COLOR_P := \033[35m
COLOR_RESET := \033[0m
IS_TTY := $(shell [ -t 1 ] && echo yes || echo no)

##########################################
## Processes

CPU_COUNT=$(shell grep -c "^processor" /proc/cpuinfo)

##########################################
## Rules

all-dbg: $(BUILD)/$(TARGET)-dbg
all-rel: $(BUILD)/$(TARGET)-rel

rel:
	$(MAKE) -j$(CPU_COUNT) all-rel
dbg:
	$(MAKE) -j$(CPU_COUNT) all-dbg

# debug excecutiable
$(BUILD)/$(TARGET)-dbg: $(OBJS)
	$(CC) -g $(CFLAGS) $(OBJS) -o $(BUILD)/$(TARGET) $(INCS) $(LIBS) $(LDFLAGS)

# release excecutiable
$(BUILD)/$(TARGET)-rel: $(OBJS)
	$(CC) -O3 $(CFLAGS) $(OBJS) -o $(BUILD)/$(TARGET) $(INCS) $(LIBS) $(LDFLAGS)
	@if [ -t 1 ]; then \
		printf "[$$(date +%H:%M:%S)][$(COLOR_G)MAKE$(COLOR_RESET)] Sripping binary\n"; \
	else \
		printf "[$$(date +%H-%M-%S)][MAKE] Sripping binary\n"; \
	fi
	strip $(BUILD)/$(TARGET)

# c++ source
$(BUILD)/%.cpp.o: %.cpp
	mkdir -p $(dir $@)
	$(CC) -c -fPIC $< -o $@ $(INCS) $(LIBS) $(CFLAGS)

# c source
$(BUILD)/%.c.o: %.c
	mkdir -p $(dir $@)
	$(CC) -c $< -o $@ $(INCS) $(LIBS) $(CFLAGS)
	@if [ -t 1 ]; then \
		printf "[$$(date +%H:%M:%S)][$(COLOR_P)BUILD$(COLOR_RESET)] $$(basename ${CC}) $<\n"; \
	else \
		printf "[$$(date +%H-%M-%S)][BUILD] $$(basename ${CC}) $<\n"; \
	fi

##########################################
## Commands

.PHONY: run
run:
	@if [ -t 1 ]; then printf "[$$(date +%H:%M:%S)][$(COLOR_B)MAKE$(COLOR_RESET)] Running './$(BUILD)/$(TARGET)'\n"; \
	else printf "[$$(date +%H-%M-%S)][MAKE] Running './$(BUILD)/$(TARGET)'\n"; fi
	$(BUILD)/$(TARGET)

.PHONY: leak
leak:
	valgrind --leak-check=full --track-origins=yes $(BUILD)/$(TARGET)

.PHONY: gdb
gdb:
	gdb $(BUILD)/$(TARGET)

.PHONY: clean
clean:
	mkdir -p $(BUILD)
	rm -r $(BUILD)
	@if [ -t 1 ]; then \
		printf "[$$(date +%H:%M:%S)][$(COLOR_R)MAKE$(COLOR_RESET)] Cleaning $(BUILD)\n"; \
	else \
		printf "[$$(date +%H-%M-%S)][MAKE] Cleaning $(BUILD)\n"; \
	fi
